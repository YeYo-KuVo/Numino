<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Numino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; }
    h1 { margin: 0 0 8px; }
    h2 { margin: 18px 0 10px; }
    button { cursor: pointer; }

    .puzzle-btn { display: block; margin: 6px 0; padding: 8px 10px; width: 100%; text-align: left; }

    .meta { margin: 10px 0 12px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    .meta div { margin: 4px 0; }

    .board-wrap { display: inline-block; border: 1px solid #ddd; border-radius: 10px; padding: 10px; }
    .grid {
      display: grid;
      gap: 4px;
      align-items: stretch;
      justify-items: stretch;
    }

    .sum {
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      min-width: 42px;
      min-height: 42px;
      border-radius: 8px;
      background: #f5f5f5;
    }

    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 42px;
      min-height: 42px;
      border: 1px solid #ccc;
      border-radius: 8px;
      user-select: none;
      font-weight: 700;
      position: relative;
      background: white;
    }

    .given {
      border: 2px solid #333;
    }


    .muted { color: #666; }
  </style>
</head>
<body>
  <h1>Numino</h1>

  <h2>Puzzles</h2>
  <div id="list">Loading…</div>

  <h2>Play</h2>
  <div id="play" class="muted">Select a puzzle above.</div>

  <script>
    const listEl = document.getElementById("list");
    const playEl = document.getElementById("play");

    // Map palette codes to display colors (tweak later to match final art direction)
    const COLOR_HEX = {
      "B": "#6f8ea8",
      "R": "#b96b5f",
      "Y": "#e6cf6a",
      "V": "#9bb36c",
      "P": "#9b8cc0",
      "G": "#8a8a8a",
      "O": "#ffa94d"
    };

    function lineFor(p) {
      const rows = p.grid?.rows ?? "?";
      const cols = p.grid?.cols ?? "?";
      const nums = (p.allowed?.numbers ?? []).join(", ");
      const colsList = (p.allowed?.colors ?? []).join(" ");
      const bias = p.bias ?? "—";
      return `${p.id} — ${rows}×${cols} — Numbers: ${nums} — Colors: ${colsList} — Bias: ${bias}`;
    }

    function buildGivenMap(givens) {
      const m = new Map(); // key "r,c" -> {num, col}
      (givens || []).forEach(g => {
        m.set(`${g.r},${g.c}`, { num: g.num ?? null, col: g.col ?? null });
      });
      return m;
    }

    function renderPuzzle(p) {
      const rows = p.grid.rows;
      const cols = p.grid.cols;
      const nums = (p.allowed?.numbers ?? []).join(", ");
      const colsList = (p.allowed?.colors ?? []).join(" ");
      const bias = p.bias ?? "—";

      const rowSums = p.constraints?.row_sums ?? [];
      const colSums = p.constraints?.col_sums ?? [];
      const givenMap = buildGivenMap(p.givens);

      // Build layout: (rows+1) x (cols+2)
      // [0,0] blank | [0,1..cols] col sums | [0, cols+1] blank
      // [1..rows, 0] blank | [1..rows,1..cols] cells | [1..rows, cols+1] row sums
      const totalCols = cols + 2;
      const totalRows = rows + 1;

      const metaHtml = `
        <div class="meta">
          <div><strong>ID:</strong> ${p.id}</div>
          <div><strong>Grid:</strong> ${rows}×${cols}</div>
          <div><strong>Numbers:</strong> ${nums}</div>
          <div><strong>Colors:</strong> ${colsList}</div>
          <div><strong>Bias:</strong> ${bias}</div>
          <div class="muted" style="margin-top:8px;">
            (Step 1) Rendering only. Next step: interactive tools + undo.
          </div>
        </div>
      `;

      const grid = document.createElement("div");
      grid.className = "grid";
      grid.style.gridTemplateColumns = `repeat(${totalCols}, auto)`;
      grid.style.gridTemplateRows = `repeat(${totalRows}, auto)`;

      function add(el) { grid.appendChild(el); }

      // Top-left blank
      add(document.createElement("div"));

      // Column sums
      for (let c = 0; c < cols; c++) {
        const d = document.createElement("div");
        d.className = "sum";
        d.textContent = (colSums[c] ?? "");
        add(d);
      }

      // Top-right blank
      add(document.createElement("div"));

      // Rows
      for (let r = 0; r < rows; r++) {
        // Left blank spacer
        add(document.createElement("div"));

        // Cells
        for (let c = 0; c < cols; c++) {
          const key = `${r},${c}`;
          const given = givenMap.get(key);

          const cell = document.createElement("div");
          cell.className = "cell";
          if (given) cell.classList.add("given");

          const num = given?.num ?? null;
          const colCode = given?.col ?? null;

          // number text (no letters)
          cell.textContent = (num === null ? "" : String(num));

          // background color fill (no letter)
          if (colCode && COLOR_HEX[colCode]) {
            cell.style.background = COLOR_HEX[colCode];
          }

          add(cell);
        }

        // Row sum (right)
        const rs = document.createElement("div");
        rs.className = "sum";
        rs.textContent = (rowSums[r] ?? "");
        add(rs);
      }

      playEl.innerHTML = "";
      playEl.className = "";
      playEl.insertAdjacentHTML("beforeend", metaHtml);

      const wrap = document.createElement("div");
      wrap.className = "board-wrap";
      wrap.appendChild(grid);
      playEl.appendChild(wrap);
    }

    fetch("puzzles.json")
      .then(r => r.json())
      .then(data => {
        const puzzles = data.puzzles || [];
        if (!puzzles.length) {
          listEl.textContent = "No puzzles found in puzzles.json";
          return;
        }

        listEl.innerHTML = "";
        const ul = document.createElement("ul");

        puzzles.forEach(p => {
          const li = document.createElement("li");
          const btn = document.createElement("button");
          btn.className = "puzzle-btn";
          btn.textContent = lineFor(p);
          btn.onclick = () => renderPuzzle(p);
          li.appendChild(btn);
          ul.appendChild(li);
        });

        listEl.appendChild(ul);
      })
      .catch(err => {
        listEl.textContent = "Failed to load puzzles.json";
        console.error(err);
      });
  </script>
</body>
</html>